moduleEnabled(whatToTest('SLEUTH_STREAM'))

configurations {
    zipkin
}

dependencies {
    compile "org.springframework:spring-jdbc"
    runtime 'org.hsqldb:hsqldb'
    compile "org.springframework.boot:spring-boot-starter-actuator"
    compile "org.springframework.cloud:spring-cloud-sleuth-zipkin-stream"
    compile "org.springframework.cloud:spring-cloud-starter-stream-${propOrSysEnvPresent('kafka') ? 'kafka' : 'rabbit'}"
    if (!propOrSysEnvPresent('kafka')) { compile "org.springframework.amqp:spring-amqp" }
    if ("$BOM_VERSION".toString() == "Brixton.RELEASE") {
        runtime "io.zipkin:zipkin-ui:1.40.2"
    } else {
        runtime "io.zipkin.java:zipkin-autoconfigure-ui:latest.release"
    }
    zipkin 'io.zipkin.java:zipkin-server:2.3.1:exec@jar'
}

createDockerTaskWithPort(9411)

task copyZipkinJar {
    doLast {
        File zipkinServerJar = configurations.zipkin.files.find { it.name.contains("zipkin-server") }
        copy {
            from zipkinServerJar.path
            into project.buildDir.path
        }
    }
}

build.dependsOn(copyZipkinJar)